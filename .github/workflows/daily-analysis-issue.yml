name: Daily Analysis Issue Creation

on:
  schedule:
    # 毎日午前9時（JST）に実行
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  create-daily-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install anthropic requests
        
    - name: Run Analysis and Create Issue
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          const fs = require('fs');
          
          // コード分析実行
          try {
            // ファイル数とサイズを取得
            const fileCount = execSync('find src -name "*.ts" -o -name "*.js" | wc -l').toString().trim();
            const totalSize = execSync('find src -name "*.ts" -o -name "*.js" -exec wc -c {} + | tail -1').toString().trim();
            
            // 最新のコミット情報
            const lastCommit = execSync('git log -1 --format="%h %s %an %ad" --date=short').toString().trim();
            
            // 今日の日付
            const today = new Date().toISOString().split('T')[0];
            
            // Issue作成
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `📊 Daily Code Analysis - ${today}`,
              body: `## 🔍 Daily Code Analysis Report
          
          **Date**: ${today}
          **Generated**: ${new Date().toISOString()}
          
          ### 📈 Code Statistics
          - **Total Files**: ${fileCount}
          - **Total Size**: ${totalSize} bytes
          - **Last Commit**: ${lastCommit}
          
          ### 🎯 Analysis Tasks
          Please review the following areas:
          
          - [ ] Check for TypeScript errors
          - [ ] Review ESLint warnings
          - [ ] Verify test coverage
          - [ ] Update documentation if needed
          - [ ] Check for security vulnerabilities
          
          ### 🤖 AI Analysis
          This issue will trigger Claude API analysis for:
          - Code quality assessment
          - Potential improvements
          - Architecture recommendations
          
          **Auto-generated by GitHub Actions**
          
          ---
          
          *This issue is automatically created daily to track code quality and improvements.*`,
              labels: ['analysis', 'daily', 'auto-generated', 'claude-ai']
            });
          } catch (error) {
            console.error('Error creating daily analysis issue:', error);
          }